#!/bin/bash

set -e

echo "ðŸš€ Cloudflare Tunnel One-Click Setup"

# Prompt for inputs
read -p "Enter your tunnel name: " TUNNEL_NAME
read -p "Enter your domain (e.g. example.com): " DOMAIN
read -p "Enter your local service port (e.g. 8080): " PORT

# Step 1: Download & install cloudflared
echo "Downloading and installing cloudflared..."
curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
chmod +x cloudflared
sudo mv cloudflared /usr/local/bin/

# Step 2: Login to Cloudflare
echo "Logging in to Cloudflare..."
cloudflared tunnel login

# Step 3: Create the tunnel
echo "Creating tunnel named $TUNNEL_NAME..."
TUNNEL_ID=$(cloudflared tunnel create "$TUNNEL_NAME" | grep -oP '(?<=Tunnel ID: )\S+')
echo "Tunnel ID: $TUNNEL_ID"

# Step 4: Create config file
CONFIG_DIR="$HOME/.cloudflared"
mkdir -p "$CONFIG_DIR"
CONFIG_FILE="$CONFIG_DIR/config.yml"

echo "Creating config file at $CONFIG_FILE..."
cat > "$CONFIG_FILE" <<EOF
tunnel: $TUNNEL_ID
credentials-file: $CONFIG_DIR/$TUNNEL_ID.json

ingress:
  - hostname: $DOMAIN
    service: http://localhost:$PORT
  - service: http_status:404
EOF

# Step 5: Route DNS to the tunnel
echo "Routing DNS for $DOMAIN to tunnel $TUNNEL_NAME..."
cloudflared tunnel route dns "$TUNNEL_NAME" "$DOMAIN"

# Step 6: Run the tunnel
echo "Starting the tunnel..."
cloudflared tunnel run "$TUNNEL_NAME"
