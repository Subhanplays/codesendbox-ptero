#!/bin/bash

echo "🚀 CLOUDFLARE TUNNEL AUTOMATED SETUP"

# Step 1: Install cloudflared if not installed
if ! command -v cloudflared &> /dev/null
then
    echo "1️⃣ Downloading & Installing cloudflared..."
    curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
    chmod +x cloudflared
    sudo mv cloudflared /usr/local/bin/
else
    echo "✅ cloudflared already installed."
fi

# Step 2: Log in to Cloudflare
echo "2️⃣ Log in to your Cloudflare account..."
cloudflared tunnel login

# Step 3: Ask for Tunnel details
read -p "Enter your Tunnel Name: " TUNNEL_NAME
read -p "Enter your Domain (e.g., example.com): " DOMAIN
read -p "Enter the Local Port your service runs on: " PORT

# Step 4: Create the tunnel
echo "3️⃣ Creating tunnel '$TUNNEL_NAME'..."
TUNNEL_ID=$(cloudflared tunnel create "$TUNNEL_NAME" | grep 'id:' | awk '{print $2}')
echo "Tunnel ID: $TUNNEL_ID"

# Step 5: Create config file
CONFIG_DIR="$HOME/.cloudflared"
mkdir -p "$CONFIG_DIR"
CONFIG_FILE="$CONFIG_DIR/config.yml"

echo "4️⃣ Writing config file..."
cat > "$CONFIG_FILE" <<EOL
tunnel: $TUNNEL_ID
credentials-file: $CONFIG_DIR/$TUNNEL_ID.json

ingress:
  - hostname: $DOMAIN
    service: http://localhost:$PORT
  - service: http_status:404
EOL

echo "✅ Config file created at $CONFIG_FILE"

# Step 6: Route DNS
echo "5️⃣ Routing DNS for $DOMAIN..."
cloudflared tunnel route dns "$TUNNEL_NAME" "$DOMAIN"

# Step 7: Run the tunnel
echo "6️⃣ Running the tunnel..."
cloudflared tunnel run "$TUNNEL_NAME"

