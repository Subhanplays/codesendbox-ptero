#!/bin/bash
# Made by SubhanPlays
# Jexactyl Panel installation script for Ubuntu 20.04/22.04+

set -e

echo "üöÄ Starting Jexactyl Panel installation..."

# -------------------
# 1Ô∏è‚É£ Install Dependencies
# -------------------
echo "[1/8] Installing dependencies..."
apt -y update
apt -y install software-properties-common curl apt-transport-https ca-certificates gnupg lsb-release

LC_ALL=C.UTF-8 add-apt-repository -y ppa:ondrej/php

# Redis repo
curl -fsSL https://packages.redis.io/gpg | gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/redis.list

# MariaDB repo (optional)
curl -LsS https://r.mariadb.com/downloads/mariadb_repo_setup | bash || true

apt update
apt -y install php8.1 php8.1-{cli,gd,mysql,pdo,mbstring,tokenizer,bcmath,xml,fpm,curl,zip} \
mariadb-server nginx tar unzip git redis

# Composer
curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# -------------------
# 2Ô∏è‚É£ Create Directory
# -------------------
echo "[2/8] Creating panel directory..."
mkdir -p /var/www/jexactyl
cd /var/www/jexactyl || exit

# -------------------
# 3Ô∏è‚É£ Download Panel
# -------------------
echo "[3/8] Downloading Jexactyl panel..."
curl -Lo panel.tar.gz https://github.com/jexactyl/jexactyl/releases/latest/download/panel.tar.gz
tar -xzvf panel.tar.gz
chmod -R 755 storage/* bootstrap/cache/

# -------------------
# 4Ô∏è‚É£ Setup Database
# -------------------
echo "[4/8] Setting up database..."
sudo systemctl start mariadb
sudo systemctl enable mariadb

echo "Please enter your desired MySQL root password:"
read -s ROOT_PASS
echo "Please enter your desired Jexactyl database password:"
read -s DB_PASS

mysql -u root <<MYSQL_SCRIPT
CREATE USER 'jexactyl'@'127.0.0.1' IDENTIFIED BY '${DB_PASS}';
CREATE DATABASE panel;
GRANT ALL PRIVILEGES ON panel.* TO 'jexactyl'@'127.0.0.1' WITH GRANT OPTION;
FLUSH PRIVILEGES;
MYSQL_SCRIPT

# -------------------
# 5Ô∏è‚É£ Install Composer Packages & Configure Env
# -------------------
echo "[5/8] Installing composer packages and configuring environment..."
cp .env.example .env
composer install --no-dev --optimize-autoloader
php artisan key:generate --force
php artisan p:environment:setup
php artisan p:environment:database
php artisan p:environment:mail

# -------------------
# 6Ô∏è‚É£ Database Migration & Admin User
# -------------------
echo "[6/8] Migrating database..."
php artisan migrate --seed --force

echo "[6/8] Create an admin user:"
php artisan p:user:make

# -------------------
# 7Ô∏è‚É£ Assign Permissions
# -------------------
echo "[7/8] Setting permissions..."
chown -R www-data:www-data /var/www/jexactyl/*
chmod -R 755 /var/www/jexactyl/storage /var/www/jexactyl/bootstrap/cache

# -------------------
# 8Ô∏è‚É£ Crontab
# -------------------
echo "[8/8] Setting up cronjob..."
(crontab -l 2>/dev/null; echo "* * * * * php /var/www/jexactyl/artisan schedule:run >> /dev/null 2>&1") | crontab -

# -------------------
# 9Ô∏è‚É£ Systemd Queue Worker
# -------------------
echo "[9/8] Setting up systemd queue worker..."
cat > /etc/systemd/system/panel.service <<EOL
[Unit]
Description=Jexactyl Queue Worker
[Service]
User=www-data
Group=www-data
Restart=always
ExecStart=/usr/bin/php /var/www/jexactyl/artisan queue:work --queue=high,standard,low --sleep=3 --tries=3
StartLimitInterval=180
StartLimitBurst=30
RestartSec=5s
[Install]
WantedBy=multi-user.target
EOL

systemctl enable --now panel.service
systemctl enable --now redis-server

echo "--------------------------------------------------"
echo " ‚úÖ Jexactyl Panel installed successfully!"
echo " Open your panel in the browser and login with the admin user you created."
echo "--------------------------------------------------"

